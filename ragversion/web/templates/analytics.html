{% extends "base.html" %}

{% block title %}Analytics - RAGVersion{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-8">

    <!-- Page Header -->
    <div class="mb-8">
        <h1 class="text-4xl font-bold text-gray-800 mb-2">Analytics</h1>
        <p class="text-gray-600">Comprehensive insights into your document tracking system</p>
    </div>

    <!-- Time Range Selector -->
    <div class="bg-white rounded-lg shadow-md p-4 mb-6">
        <div class="flex items-center gap-4">
            <label class="text-sm font-medium text-gray-700">Time Range:</label>
            <select id="timeRange"
                    class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none bg-white"
                    onchange="updateCharts(this.value)">
                <option value="7">Last 7 Days</option>
                <option value="30" selected>Last 30 Days</option>
                <option value="90">Last 90 Days</option>
                <option value="365">Last Year</option>
            </select>
            <button onclick="location.reload()"
                    class="ml-auto px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition">
                <svg class="w-4 h-4 inline mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                </svg>
                Refresh
            </button>
        </div>
    </div>

    <!-- Key Metrics Grid -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
        <div class="bg-white rounded-lg shadow-md p-6 border-l-4 border-blue-500">
            <p class="text-gray-600 text-sm font-medium">Total Changes</p>
            <p class="text-3xl font-bold text-gray-800 mt-1">{{ analytics.total_changes }}</p>
            <p class="text-sm text-gray-500 mt-2">
                {% if analytics.change_trend > 0 %}
                <span class="text-green-600">↑ {{ "%.1f"|format(analytics.change_trend) }}%</span>
                {% else %}
                <span class="text-red-600">↓ {{ "%.1f"|format(analytics.change_trend|abs) }}%</span>
                {% endif %}
                vs previous period
            </p>
        </div>

        <div class="bg-white rounded-lg shadow-md p-6 border-l-4 border-green-500">
            <p class="text-gray-600 text-sm font-medium">Active Documents</p>
            <p class="text-3xl font-bold text-gray-800 mt-1">{{ analytics.active_documents }}</p>
            <p class="text-sm text-gray-500 mt-2">Modified in selected period</p>
        </div>

        <div class="bg-white rounded-lg shadow-md p-6 border-l-4 border-purple-500">
            <p class="text-gray-600 text-sm font-medium">Avg Changes/Day</p>
            <p class="text-3xl font-bold text-gray-800 mt-1">{{ "%.1f"|format(analytics.avg_changes_per_day) }}</p>
            <p class="text-sm text-gray-500 mt-2">Daily activity rate</p>
        </div>

        <div class="bg-white rounded-lg shadow-md p-6 border-l-4 border-orange-500">
            <p class="text-gray-600 text-sm font-medium">Peak Activity Day</p>
            <p class="text-3xl font-bold text-gray-800 mt-1">{{ analytics.peak_day_count }}</p>
            <p class="text-sm text-gray-500 mt-2">{{ analytics.peak_day_date }}</p>
        </div>
    </div>

    <!-- Version Growth Timeline -->
    <div class="bg-white rounded-lg shadow-md p-6 mb-6">
        <h2 class="text-xl font-semibold text-gray-800 mb-4">Version Growth Over Time</h2>
        <div class="relative" style="height: 300px;">
            <canvas id="versionGrowthChart"></canvas>
        </div>
    </div>

    <!-- Activity Heatmap & Storage Trends -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
        <!-- Activity Heatmap -->
        <div class="bg-white rounded-lg shadow-md p-6">
            <h2 class="text-xl font-semibold text-gray-800 mb-4">Activity Heatmap</h2>
            <div id="activityHeatmap" class="overflow-x-auto">
                <!-- GitHub-style contribution graph will be rendered here -->
            </div>
        </div>

        <!-- Storage Growth -->
        <div class="bg-white rounded-lg shadow-md p-6">
            <h2 class="text-xl font-semibold text-gray-800 mb-4">Storage Growth</h2>
            <div class="relative" style="height: 250px;">
                <canvas id="storageGrowthChart"></canvas>
            </div>
        </div>
    </div>

    <!-- Change Type Distribution & Top Contributors -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
        <!-- Change Type Distribution -->
        <div class="bg-white rounded-lg shadow-md p-6">
            <h2 class="text-xl font-semibold text-gray-800 mb-4">Change Type Distribution</h2>
            <div class="relative" style="height: 250px;">
                <canvas id="changeTypeChart"></canvas>
            </div>
        </div>

        <!-- Most Active Documents -->
        <div class="bg-white rounded-lg shadow-md p-6">
            <h2 class="text-xl font-semibold text-gray-800 mb-4">Most Modified Documents</h2>
            <div class="space-y-3">
                {% for doc in analytics.top_modified_docs %}
                <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                    <div class="flex-1 min-w-0">
                        <a href="/documents/{{ doc.id }}" class="text-sm font-medium text-blue-600 hover:text-blue-800 truncate block">
                            {{ doc.file_name }}
                        </a>
                        <p class="text-xs text-gray-500">{{ doc.changes_count }} changes</p>
                    </div>
                    <div class="ml-4 flex-shrink-0">
                        <div class="w-24 bg-gray-200 rounded-full h-2">
                            <div class="bg-blue-600 h-2 rounded-full" style="width: {{ (doc.changes_count / analytics.max_changes * 100)|int }}%"></div>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>

    <!-- Activity Calendar (GitHub-style) -->
    <div class="bg-white rounded-lg shadow-md p-6 mb-6">
        <h2 class="text-xl font-semibold text-gray-800 mb-4">Activity Calendar</h2>
        <p class="text-sm text-gray-600 mb-4">
            <span class="font-medium">{{ analytics.calendar_total_changes }}</span> changes in the last year
        </p>
        <div id="activityCalendar" class="overflow-x-auto"></div>
    </div>

    <!-- File Type Activity Breakdown -->
    <div class="bg-white rounded-lg shadow-md p-6">
        <h2 class="text-xl font-semibold text-gray-800 mb-4">Activity by File Type</h2>
        <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">File Type</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Documents</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Total Changes</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Avg Changes/Doc</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Activity</th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200">
                    {% for ft in analytics.file_type_activity %}
                    <tr class="hover:bg-gray-50">
                        <td class="px-6 py-4 whitespace-nowrap">
                            <span class="px-2 py-1 text-xs font-medium rounded-full bg-gray-100 text-gray-800">
                                {{ ft.type.upper() }}
                            </span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">{{ ft.doc_count }}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">{{ ft.total_changes }}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">{{ "%.1f"|format(ft.avg_changes) }}</td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="w-full bg-gray-200 rounded-full h-2">
                                <div class="bg-blue-600 h-2 rounded-full" style="width: {{ (ft.total_changes / analytics.total_changes * 100)|int }}%"></div>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

</div>

<script>
    // Version Growth Timeline Chart
    const versionGrowthCtx = document.getElementById('versionGrowthChart');
    if (versionGrowthCtx) {
        new Chart(versionGrowthCtx.getContext('2d'), {
            type: 'line',
            data: {
                labels: {{ analytics.timeline_labels | tojson }},
                datasets: [{
                    label: 'Total Versions',
                    data: {{ analytics.timeline_versions | tojson }},
                    borderColor: '#3b82f6',
                    backgroundColor: 'rgba(59, 130, 246, 0.1)',
                    tension: 0.4,
                    fill: true,
                    pointRadius: 3,
                    pointHoverRadius: 6
                }, {
                    label: 'New Documents',
                    data: {{ analytics.timeline_documents | tojson }},
                    borderColor: '#10b981',
                    backgroundColor: 'rgba(16, 185, 129, 0.1)',
                    tension: 0.4,
                    fill: true,
                    pointRadius: 3,
                    pointHoverRadius: 6
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'top'
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true
                    }
                }
            }
        });
    }

    // Storage Growth Chart
    const storageGrowthCtx = document.getElementById('storageGrowthChart');
    if (storageGrowthCtx) {
        new Chart(storageGrowthCtx.getContext('2d'), {
            type: 'bar',
            data: {
                labels: {{ analytics.storage_labels | tojson }},
                datasets: [{
                    label: 'Storage (MB)',
                    data: {{ analytics.storage_data | tojson }},
                    backgroundColor: '#8b5cf6',
                    borderColor: '#7c3aed',
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true
                    }
                }
            }
        });
    }

    // Change Type Distribution Chart
    const changeTypeCtx = document.getElementById('changeTypeChart');
    if (changeTypeCtx) {
        new Chart(changeTypeCtx.getContext('2d'), {
            type: 'doughnut',
            data: {
                labels: {{ analytics.change_type_labels | tojson }},
                datasets: [{
                    data: {{ analytics.change_type_counts | tojson }},
                    backgroundColor: [
                        '#10b981', // CREATED - green
                        '#3b82f6', // MODIFIED - blue
                        '#ef4444', // DELETED - red
                        '#8b5cf6'  // RESTORED - purple
                    ]
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'right'
                    }
                }
            }
        });
    }

    // GitHub-style Activity Calendar
    function renderActivityCalendar() {
        const calendarData = {{ analytics.calendar_data | tojson }};
        const calendarContainer = document.getElementById('activityCalendar');

        if (!calendarContainer || !calendarData) return;

        // Group by weeks
        const weeks = [];
        let currentWeek = [];

        calendarData.forEach((day, index) => {
            currentWeek.push(day);
            if (currentWeek.length === 7 || index === calendarData.length - 1) {
                weeks.push([...currentWeek]);
                currentWeek = [];
            }
        });

        // Determine color intensity based on activity
        function getColor(count) {
            if (count === 0) return '#ebedf0';
            if (count <= 2) return '#9be9a8';
            if (count <= 5) return '#40c463';
            if (count <= 10) return '#30a14e';
            return '#216e39';
        }

        // Build calendar HTML
        let calendarHTML = '<div class="flex gap-1">';

        // Month labels
        calendarHTML += '<div class="flex flex-col gap-1 mr-2 text-xs text-gray-600">';
        ['Mon', '', 'Wed', '', 'Fri', '', 'Sun'].forEach(day => {
            calendarHTML += `<div class="h-3">${day}</div>`;
        });
        calendarHTML += '</div>';

        // Day squares
        weeks.forEach(week => {
            calendarHTML += '<div class="flex flex-col gap-1">';
            week.forEach(day => {
                const color = getColor(day.count);
                const tooltip = `${day.date}: ${day.count} changes`;
                calendarHTML += `
                    <div class="w-3 h-3 rounded-sm"
                         style="background-color: ${color}"
                         title="${tooltip}"></div>
                `;
            });
            calendarHTML += '</div>';
        });

        calendarHTML += '</div>';

        // Legend
        calendarHTML += `
            <div class="flex items-center gap-2 mt-4 text-xs text-gray-600">
                <span>Less</span>
                <div class="w-3 h-3 rounded-sm" style="background-color: #ebedf0"></div>
                <div class="w-3 h-3 rounded-sm" style="background-color: #9be9a8"></div>
                <div class="w-3 h-3 rounded-sm" style="background-color: #40c463"></div>
                <div class="w-3 h-3 rounded-sm" style="background-color: #30a14e"></div>
                <div class="w-3 h-3 rounded-sm" style="background-color: #216e39"></div>
                <span>More</span>
            </div>
        `;

        calendarContainer.innerHTML = calendarHTML;
    }

    // Render calendar on page load
    document.addEventListener('DOMContentLoaded', renderActivityCalendar);

    // Update charts based on time range (placeholder - would need API endpoint)
    function updateCharts(days) {
        console.log(`Updating charts for ${days} days`);
        // TODO: Implement API call to fetch data for selected time range
        // For now, just reload the page with query param
        window.location.href = `?days=${days}`;
    }
</script>
{% endblock %}
